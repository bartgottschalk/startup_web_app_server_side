# ============================================================================
# GitHub Actions Workflow: PR Validation
# ============================================================================
#
# PURPOSE:
# Run linting and tests on pull requests to catch issues before merge.
# This ensures code quality and prevents broken code from reaching master.
#
# TRIGGERS:
# - Pull requests targeting master branch
#
# CHECKS PERFORMED:
# 1. Flake8 linting (code style)
# 2. Unit tests (712 tests)
# 3. Functional tests (28 tests with Selenium/Firefox)
#
# ============================================================================

name: PR Validation

on:
  pull_request:
    branches:
      - master

jobs:
  # ==========================================================================
  # JOB: Lint and Test
  # ==========================================================================
  validate:
    name: Lint and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: startupwebapp_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create settings_secret.py for CI
        run: |
          cat > StartupWebApp/StartupWebApp/settings_secret.py << 'EOF'
          # CI/CD Test Settings (auto-generated by GitHub Actions)
          import os

          SECRET_KEY = 'test-secret-key-for-ci-only-not-secure'
          ALLOWED_HOSTS = [
              'localhost',
              'backend',
              'testserver',
              'localliveservertestcase.startupwebapp.com',
              'localliveservertestcaseapi.startupwebapp.com',
          ]
          SESSION_COOKIE_SECURE = False
          SESSION_COOKIE_DOMAIN = None
          CSRF_COOKIE_SECURE = False
          CSRF_COOKIE_DOMAIN = ".startupwebapp.com"
          CSRF_TRUSTED_ORIGINS = [
              'http://localhost',
              'http://localhost.startupwebapp.com:8080',
              'http://testserver',
              'http://localliveservertestcase.startupwebapp.com',
              'http://localliveservertestcase.startupwebapp.com:8080',
              'http://localliveservertestcaseapi.startupwebapp.com',
              'http://localliveservertestcaseapi.startupwebapp.com:60767',
          ]
          DEBUG = True
          ENVIRONMENT_DOMAIN = 'http://localhost'
          EMAIL_HOST = 'localhost'
          EMAIL_PORT = 1025
          EMAIL_USE_TLS = False
          EMAIL_HOST_USER = ''
          EMAIL_HOST_PASSWORD = ''
          EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
          DATABASES = {
              'default': {
                  'ENGINE': 'django.db.backends.postgresql',
                  'NAME': os.environ.get('DATABASE_NAME', 'startupwebapp_test'),
                  'USER': os.environ.get('DATABASE_USER', 'postgres'),
                  'PASSWORD': os.environ.get('DATABASE_PASSWORD', 'postgres'),
                  'HOST': os.environ.get('DATABASE_HOST', 'localhost'),
                  'PORT': os.environ.get('DATABASE_PORT', '5432'),
                  'CONN_MAX_AGE': 600,
              }
          }
          STRIPE_SERVER_SECRET_KEY = 'sk_test_ci_placeholder'
          STRIPE_PUBLISHABLE_SECRET_KEY = 'pk_test_ci_placeholder'
          STRIPE_WEBHOOK_SECRET = 'whsec_test_ci_placeholder'
          STRIPE_LOG_LEVEL = 'debug'
          CORS_ORIGIN_WHITELIST = (
              'http://localhost:8080',
              'http://localhost.startupwebapp.com:8080',
              'http://localliveservertestcase.startupwebapp.com',
              'http://localliveservertestcase.startupwebapp.com:8080',
              'http://frontend',
              'http://testserver',
          )
          CORS_ALLOW_CREDENTIALS = True
          EOF

      - name: Run flake8 linting
        run: |
          cd StartupWebApp
          flake8 user order clientevent StartupWebApp --max-line-length=120 --exclude=*/migrations/* --statistics

      - name: Run unit tests
        env:
          DATABASE_ENGINE: postgresql
          DATABASE_NAME: startupwebapp_test
          DATABASE_USER: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
        run: |
          cd StartupWebApp
          python manage.py test order.tests user.tests clientevent.tests StartupWebApp.tests --parallel=4

      - name: Set up Firefox
        run: |
          firefox --version || sudo snap install firefox
          firefox --version

      - name: Install geckodriver
        run: |
          wget https://github.com/mozilla/geckodriver/releases/download/v0.33.0/geckodriver-v0.33.0-linux64.tar.gz
          tar -xzf geckodriver-v0.33.0-linux64.tar.gz
          sudo mv geckodriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/geckodriver

      # Clone frontend master branch - validates backend+frontend compatibility
      - name: Clone frontend repository
        run: |
          cd /tmp
          git clone https://github.com/bartgottschalk/startup_web_app_client_side.git frontend
          sudo chown -R www-data:www-data frontend
          echo "Frontend cloned from master branch"

      - name: Install and configure nginx
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx
          sudo cp nginx.conf /etc/nginx/sites-available/startupwebapp
          sudo sed -i 's|/usr/share/nginx/html|/tmp/frontend|g' /etc/nginx/sites-available/startupwebapp
          sudo sed -i 's|listen 80;|listen 8080;|g' /etc/nginx/sites-available/startupwebapp
          sudo ln -sf /etc/nginx/sites-available/startupwebapp /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          echo "127.0.0.1    localliveservertestcase.startupwebapp.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1    localliveservertestcaseapi.startupwebapp.com" | sudo tee -a /etc/hosts
          sudo systemctl restart nginx

      - name: Collect static files
        run: |
          cd StartupWebApp
          python manage.py collectstatic --noinput --clear
          echo "âœ“ Static files collected"

      - name: Run functional tests
        env:
          DATABASE_ENGINE: postgresql
          DATABASE_NAME: startupwebapp_test
          DATABASE_USER: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          HEADLESS: "TRUE"
          CI_ENV: "true"
        run: |
          cd StartupWebApp
          python manage.py test functional_tests

      - name: Test Summary
        if: always()
        run: |
          echo "=========================================="
          echo "PR Validation Complete"
          echo "=========================================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo ""
          echo "Checks performed:"
          echo "  - Flake8 linting"
          echo "  - Unit tests (712 tests)"
          echo "  - Functional tests (28 tests)"
          echo "=========================================="
