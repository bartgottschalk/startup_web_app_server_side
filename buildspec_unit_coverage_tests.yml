version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: "us-west-2"

    SETTINGS_SECRET_SRC: |
      SECRET_KEY = 'uM*&23jbOIYQEF98u2h4kfnbPIe8yXrCTqmOS0gMnX'

      ALLOWED_HOSTS = ['localapi.startupwebapp.com', 'localliveservertestcaseapi.startupwebapp.com']

      SESSION_COOKIE_SECURE = False
      SESSION_COOKIE_DOMAIN = "localapi.startupwebapp.com"

      CSRF_COOKIE_SECURE = False
      CSRF_TRUSTED_ORIGINS = "localhost.startupwebapp.com"

      DEBUG = True

      ENVIRONMENT_DOMAIN = 'http://localhost.startupwebapp.com'

      EMAIL_HOST_USER = 'REPLACE_WITH_TEST_EMAIL_USER'
      EMAIL_HOST_PASSWORD = 'REPLACE_WITH_TEST_EMAIL_PASSWORD'

      DATABASES = {
          'default': {
              'ENGINE': 'django.db.backends.sqlite3',
              'NAME': 'swa_unittest',
              'USER': 'django_unittest',
              'PASSWORD': 'imatester',
              'HOST': '127.0.0.1',
          }
      }

      STRIPE_SERVER_SECRET_KEY = 'sk_test_REPLACE_WITH_TEST_KEY'
      STRIPE_PUBLISHABLE_SECRET_KEY = 'pk_test_REPLACE_WITH_TEST_KEY'
      STRIPE_LOG_LEVEL = 'debug'

      # CORS Config
      CORS_ORIGIN_WHITELIST = (
          'localliveservertestcase.startupwebapp.com',
          'localhost.startupwebapp.com',
      )

phases:
  install:
    commands:
      - django-admin --version
  pre_build:
    commands:
      # setup django test app
      - cd $CODEBUILD_SRC_DIR
      - cd StartupWebApp/StartupWebApp
      - echo "$SETTINGS_SECRET_SRC" > settings_secret.py
      
  build:
    commands:
      - echo Build started on `date`
      - cd $CODEBUILD_SRC_DIR
      - cd StartupWebApp

      # coverage test
      - coverage run --source='.' manage.py test StartupWebApp
      - coverage report --fail-under=23

  post_build:
    commands:
      - echo Build completed on `date`

artifacts:
  files:
